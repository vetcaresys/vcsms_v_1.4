<?php
require 'config.php';
//start
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $role = $_POST['role'];
    $name = $_POST['name'];
    $email = $_POST['email'];
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
    $contact = $_POST['contact'];
    $address = $_POST['address'];

    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $name = $_POST['name'] ?? '';
        $email = $_POST['email'] ?? '';
        $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
        $role = $_POST['role'] ?? 'pet_owner';
        $contact = $_POST['contact'] ?? '';
        $address = $_POST['address'] ?? '';
        $profile_picture = null;

        // Handle profile picture upload
        if (!empty($_FILES['profile_picture']['name'])) {
            $upload_dir = "uploads/profiles/";   // ✅ instead of "uploads/"
            if (!is_dir($upload_dir)) mkdir($upload_dir, 0777, true);

            $file_name = time() . "_" . basename($_FILES["profile_picture"]["name"]);
            $target_file = $upload_dir . $file_name;

            if (move_uploaded_file($_FILES["profile_picture"]["tmp_name"], $target_file)) {
                $profile_picture = $file_name; // ✅ store only filename
            }
        }

        $stmt = $pdo->prepare("INSERT INTO users 
        (name, email, password, role, contact_number, address, profile_picture)
        VALUES (?, ?, ?, ?, ?, ?, ?)");
        $stmt->execute([$name, $email, $password, $role, $contact, $address, $profile_picture]); //end

        $user_id = $pdo->lastInsertId();

        // if clinic owner, insert also into clinics table
        if ($role === 'clinic_owner') {
            $status = 'pending'; // clinic owner accounts should be pending until approved

            if (!empty($_FILES['business_permit']['name'])) {
                $permit_dir = "uploads/permits/";
                if (!is_dir($permit_dir)) mkdir($permit_dir, 0777, true);

                $permit_name = basename($_FILES["business_permit"]["name"]);
                $permit_file = $permit_dir . time() . "_" . $permit_name;
                move_uploaded_file($_FILES["business_permit"]["tmp_name"], $permit_file);

                // Insert to clinics table
                $stmtClinic = $pdo->prepare("INSERT INTO clinics 
                        (user_id, clinic_name, address, contact_info, logo, business_permit, status)
                        VALUES (?, ?, ?, ?, ?, ?, ?)");
                $stmtClinic->execute([
                    $user_id,
                    $name . "'s Clinic",  // default clinic name, pwede pa ma-update sa profile
                    $address,
                    $contact,
                    $target_file,         // reuse profile picture as logo for now
                    $permit_file,
                    $status
                ]);
            } else {
                $error_message = "Business permit is required for clinic owners.";
            }
        }

        if (empty($error_message)) {
            $success_message = "Registration successful! You may now log in.";
        }
    } else {
        $error_message = "Error uploading the profile picture.";
    }
}

?>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - VetCareSys</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .register-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
        }

        .form-control,
        .form-select {
            border-radius: 10px;
        }

        .btn-custom {
            background-color: #0984e3;
            color: white;
            border-radius: 10px;
            transition: 0.3s;
        }

        .btn-custom:hover {
            background-color: #74b9ff;
            color: black;
        }
    </style>
</head>

<body>

    <div class="register-card">
        <h2 class="text-center mb-4 text-primary"><i class="bi bi-person-plus-fill"></i> Register to VetCareSys</h2>

        <?php if (!empty($success_message)): ?>
            <div class="alert alert-success"><?= $success_message ?></div>
        <?php elseif (!empty($error_message)): ?>
            <div class="alert alert-danger"><?= $error_message ?></div>
        <?php endif; ?>

        <form method="POST" action="" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">Role</label>
                <select name="role" class="form-select" required>
                    <option value="">-- Select Role --</option>
                    <option value="pet_owner">Pet Owner</option>
                    <option value="clinic_owner">Clinic Owner</option>
                </select>
            </div>

            <div class="mb-3">
                <input type="text" name="name" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="mb-3">
                <input type="email" name="email" class="form-control" placeholder="Email" required>
            </div>
            <div class="mb-3">
                <input type="password" name="password" class="form-control" placeholder="Password" required>
            </div>
            <div class="mb-3">
                <input type="text" name="contact" class="form-control" placeholder="Contact Number" required>
            </div>
            <div class="mb-3">
                <textarea name="address" class="form-control" placeholder="Address" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Upload Profile Picture</label>
                <input type="file" name="profile_picture" class="form-control" accept="image/*" required>
            </div>

            <div class="mb-3 clinic-only" style="display:none;">
                <label class="form-label">Upload Business Permit</label>
                <input type="file" name="business_permit" class="form-control" accept="image/*,.pdf">
            </div>

            <button type="submit" class="btn btn-custom w-100 mb-2">Register</button>
            <div class="text-center">
                <a href="login.php" class="text-decoration-none">Have already an Account?</a> |
                <a href="index.php" class="text-decoration-none">Back to Homepage</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelector('[name="role"]').addEventListener('change', function() {
            document.querySelector('.clinic-only').style.display = this.value === 'clinic_owner' ? 'block' : 'none';
        });
    </script>
</body>

</html>